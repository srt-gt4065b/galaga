<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°¤ëŸ¬ê·¸ - ìš°ì£¼ê´´ë¬¼ í‡´ì¹˜ì‘ì „</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
        }

        .game-container {
            background: #111;
            border: 4px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            max-width: 640px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 36px;
            color: #ff0;
            text-shadow: 0 0 10px #ff0, 0 0 20px #ff0;
            margin-bottom: 5px;
            letter-spacing: 3px;
        }

        .game-subtitle {
            font-size: 14px;
            color: #0ff;
            letter-spacing: 2px;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 5px;
        }

        .stat {
            font-size: 18px;
            color: #0f0;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        canvas {
            display: block;
            background: #000;
            border: 3px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .controls {
            margin-top: 15px;
            text-align: center;
        }

        .btn {
            background: #ff0;
            color: #000;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            transition: all 0.2s;
        }

        .btn:hover {
            background: #ffff00;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .btn-secondary:hover {
            background: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .instructions {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #0f0;
            border-radius: 5px;
            font-size: 13px;
            line-height: 1.8;
            color: #0ff;
        }

        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .screen-content {
            background: #111;
            padding: 40px;
            border: 4px solid #00ff00;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
            max-width: 500px;
            width: 90%;
        }

        .screen-title {
            font-size: 36px;
            color: #ff0;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #ff0;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            color: #0ff;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #00ff00;
            background: #000;
            color: #fff;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .error-message {
            color: #f00;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .game-over-screen,
        .stage-clear-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border: 4px solid #ff0;
            border-radius: 10px;
            text-align: center;
            display: none;
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.5);
            z-index: 5;
        }

        .game-over-screen.show,
        .stage-clear-screen.show {
            display: block;
        }

        .stage-clear-screen {
            border-color: #0ff;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .blink {
            animation: blink 0.5s infinite;
        }

        .screen-container {
            position: relative;
        }

        .hidden {
            display: none !important;
        }

        .leaderboard {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px;
            border: 1px solid #00ff00;
            text-align: center;
        }

        .leaderboard-table th {
            background: #000;
            color: #0ff;
            font-weight: bold;
        }

        .leaderboard-table td {
            background: rgba(0, 255, 0, 0.05);
        }

        .leaderboard-table tr:hover td {
            background: rgba(0, 255, 0, 0.15);
        }

        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        .current-user {
            background: rgba(255, 255, 0, 0.2) !important;
        }

        .loading {
            color: #0ff;
            font-size: 18px;
            margin: 20px 0;
        }

        .user-info {
            background: rgba(0, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #0ff;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="screen-overlay">
        <div class="screen-content">
            <div class="screen-title">ğŸš€ GALAGA ğŸš€</div>
            <div style="color: #0ff; margin-bottom: 30px; font-size: 16px;">
                ìš°ì£¼ê´´ë¬¼ í‡´ì¹˜ì‘ì „ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">ì´ë¦„</label>
                    <input type="text" id="nameInput" class="form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">í•™ë²ˆ</label>
                    <input type="text" id="studentIdInput" class="form-input" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                
                <div class="error-message" id="loginError">
                    ì´ë¦„ê³¼ í•™ë²ˆì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
                
                <button type="submit" class="btn">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
                <button type="button" class="btn btn-secondary" onclick="showLeaderboard()">ìˆœìœ„í‘œ ë³´ê¸°</button>
            </form>
        </div>
    </div>

    <!-- ìˆœìœ„í‘œ í™”ë©´ -->
    <div id="leaderboardScreen" class="screen-overlay hidden">
        <div class="screen-content" style="max-width: 700px;">
            <div class="screen-title">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</div>
            <div style="color: #0ff; margin-bottom: 20px;">
                ìµœê³  ì ìˆ˜ TOP 20
            </div>
            
            <div class="loading" id="leaderboardLoading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            
            <div class="leaderboard" id="leaderboardContent" style="display: none;">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì´ë¦„</th>
                            <th>í•™ë²ˆ</th>
                            <th>ì ìˆ˜</th>
                            <th>ìŠ¤í…Œì´ì§€</th>
                            <th>ë‚ ì§œ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
            
            <button class="btn" onclick="hideLeaderboard()" style="margin-top: 20px;">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
    <div class="game-container hidden" id="gameContainer">
        <div class="game-header">
            <div class="game-title">ğŸš€ GALAGA ğŸš€</div>
            <div class="game-subtitle">â€» ìš°ì£¼ê´´ë¬¼ í‡´ì¹˜ì‘ì „ â€»</div>
        </div>

        <div class="user-info" id="userInfo">
            í”Œë ˆì´ì–´: <span id="playerName"></span> (<span id="playerStudentId"></span>)
        </div>

        <div class="game-stats">
            <div class="stat">ì ìˆ˜: <span class="stat-value" id="score">0</span></div>
            <div class="stat">ìŠ¤í…Œì´ì§€: <span class="stat-value" id="stage">1</span></div>
            <div class="stat">ëª©ìˆ¨: <span class="stat-value" id="lives">â¤ï¸â¤ï¸â¤ï¸</span></div>
            <div class="stat">ìµœê³ ì ìˆ˜: <span class="stat-value" id="highScore">0</span></div>
        </div>

        <div class="screen-container">
            <canvas id="gameCanvas" width="600" height="700"></canvas>
            
            <div class="game-over-screen" id="gameOverScreen">
                <div class="game-over-title blink" style="font-size: 48px; color: #f00; margin-bottom: 20px; font-weight: bold; text-shadow: 0 0 10px #f00;">GAME OVER</div>
                <div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
                    ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span>
                </div>
                <div style="color: #0ff; margin-bottom: 20px;" id="saveMessage">
                    ì ìˆ˜ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...
                </div>
                <button class="btn" onclick="game.restart()">ë‹¤ì‹œ ì‹œì‘</button>
                <button class="btn btn-secondary" onclick="showLeaderboardFromGame()">ìˆœìœ„í‘œ ë³´ê¸°</button>
                <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="stage-clear-screen" id="stageClearScreen">
                <div class="stage-clear-title" style="font-size: 48px; color: #0ff; margin-bottom: 20px; font-weight: bold; text-shadow: 0 0 10px #0ff;">STAGE CLEAR!</div>
                <div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
                    ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì¤€ë¹„ì¤‘...
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="game.start()">ì‹œì‘ (Enter)</button>
            <button class="btn" onclick="game.pause()">ì¼ì‹œì •ì§€ (P)</button>
            <button class="btn btn-secondary" onclick="showLeaderboardFromGame()">ìˆœìœ„í‘œ</button>
            <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="instructions">
            <strong style="color: #ff0;">ğŸ® ì¡°ì‘ë²•:</strong><br>
            â† â†’ ë°©í–¥í‚¤: ìš°ì£¼ì„  ì´ë™<br>
            ìŠ¤í˜ì´ìŠ¤ë°”: ë¯¸ì‚¬ì¼ ë°œì‚¬<br>
            Pí‚¤: ì¼ì‹œì •ì§€<br>
            <br>
            <strong style="color: #0ff;">ğŸ“– ê²Œì„ ê·œì¹™:</strong><br>
            â€¢ ëª¨ë“  ì ì„ ê²©ì¶”í•˜ë©´ ë‹¤ìŒ ìŠ¤í…Œì´ì§€!<br>
            â€¢ ì ì˜ ê³µê²©ì„ í”¼í•˜ì„¸ìš”!<br>
            â€¢ 10ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ ê²Œì„ ì™„ë£Œ!<br>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // âš ï¸ ì—¬ê¸°ì— Firebase ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”
        const firebaseConfig = {
            apiKey: "AIzaSyDqBweK0EOcGUZsGqZer32bb3nkrPJRCJM",
  authDomain: "galloge-game.firebaseapp.com",
  databaseURL: "https://galloge-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "galloge-game",
  storageBucket: "galloge-game.firebasestorage.app",
  messagingSenderId: "498585266086",
  appId: "1:498585266086:web:799b8566e04e41db589167"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ì „ì—­ ë³€ìˆ˜
        window.currentUser = null;
        window.db = db;

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('nameInput').value.trim();
            const studentId = document.getElementById('studentIdInput').value.trim();
            
            if (!name || !studentId) {
                document.getElementById('loginError').classList.add('show');
                return;
            }
            
            document.getElementById('loginError').classList.remove('show');
            
            // ì‚¬ìš©ì ì •ë³´ ì €ì¥
            window.currentUser = {
                name: name,
                studentId: studentId
            };
            
            // í™”ë©´ ì „í™˜
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('playerName').textContent = name;
            document.getElementById('playerStudentId').textContent = studentId;
            
            // ìµœê³  ì ìˆ˜ ë¡œë“œ
            loadHighScore();
        });

        // ìµœê³  ì ìˆ˜ ë¡œë“œ
        window.loadHighScore = async function() {
            try {
                const scoresRef = collection(db, 'galaga_scores');
                const q = query(scoresRef, orderBy('score', 'desc'), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const topScore = querySnapshot.docs[0].data();
                    document.getElementById('highScore').textContent = topScore.score;
                }
            } catch (error) {
                console.error('ìµœê³  ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };

        // ì ìˆ˜ ì €ì¥
        window.saveScore = async function(score, stage) {
            if (!window.currentUser) return;
            
            try {
                const scoresRef = collection(db, 'galaga_scores');
                await addDoc(scoresRef, {
                    name: window.currentUser.name,
                    studentId: window.currentUser.studentId,
                    score: score,
                    stage: stage,
                    timestamp: serverTimestamp()
                });
                
                document.getElementById('saveMessage').textContent = 'âœ… ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                document.getElementById('saveMessage').style.color = '#0f0';
            } catch (error) {
                console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
                document.getElementById('saveMessage').textContent = 'âŒ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨';
                document.getElementById('saveMessage').style.color = '#f00';
            }
        };

        // ìˆœìœ„í‘œ ë¡œë“œ
        window.loadLeaderboard = async function() {
            try {
                document.getElementById('leaderboardLoading').style.display = 'block';
                document.getElementById('leaderboardContent').style.display = 'none';
                
                const scoresRef = collection(db, 'galaga_scores');
                const q = query(scoresRef, orderBy('score', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                
                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = '';
                
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = tbody.insertRow();
                    
                    // í˜„ì¬ ì‚¬ìš©ìì˜ ê¸°ë¡ì¸ ê²½ìš° ê°•ì¡°
                    if (window.currentUser && 
                        data.name === window.currentUser.name && 
                        data.studentId === window.currentUser.studentId) {
                        row.classList.add('current-user');
                    }
                    
                    // ìˆœìœ„ ì…€
                    const rankCell = row.insertCell();
                    rankCell.textContent = rank;
                    if (rank === 1) rankCell.classList.add('rank-1');
                    else if (rank === 2) rankCell.classList.add('rank-2');
                    else if (rank === 3) rankCell.classList.add('rank-3');
                    
                    // ì´ë¦„
                    row.insertCell().textContent = data.name;
                    
                    // í•™ë²ˆ
                    row.insertCell().textContent = data.studentId;
                    
                    // ì ìˆ˜
                    row.insertCell().textContent = data.score.toLocaleString();
                    
                    // ìŠ¤í…Œì´ì§€
                    row.insertCell().textContent = data.stage;
                    
                    // ë‚ ì§œ
                    const dateCell = row.insertCell();
                    if (data.timestamp) {
                        const date = data.timestamp.toDate();
                        dateCell.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                    } else {
                        dateCell.textContent = '-';
                    }
                    
                    rank++;
                });
                
                document.getElementById('leaderboardLoading').style.display = 'none';
                document.getElementById('leaderboardContent').style.display = 'block';
            } catch (error) {
                console.error('ìˆœìœ„í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('leaderboardLoading').textContent = 'ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                document.getElementById('leaderboardLoading').style.color = '#f00';
            }
        };

        // ìˆœìœ„í‘œ í‘œì‹œ (ë¡œê·¸ì¸ í™”ë©´ì—ì„œ)
        window.showLeaderboard = function() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            loadLeaderboard();
        };

        // ìˆœìœ„í‘œ í‘œì‹œ (ê²Œì„ í™”ë©´ì—ì„œ)
        window.showLeaderboardFromGame = function() {
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            loadLeaderboard();
        };

        // ìˆœìœ„í‘œ ìˆ¨ê¸°ê¸°
        window.hideLeaderboard = function() {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            
            if (window.currentUser) {
                document.getElementById('gameContainer').classList.remove('hidden');
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.logout = function() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.currentUser = null;
                document.getElementById('gameContainer').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('nameInput').value = '';
                document.getElementById('studentIdInput').value = '';
                
                // ê²Œì„ ì¢…ë£Œ
                if (window.game) {
                    game.isRunning = false;
                }
            }
        };
    </script>

    <!-- ê²Œì„ ë¡œì§ -->
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const game = {
            player: {
                x: canvas.width / 2 - 20,
                y: canvas.height - 80,
                width: 40,
                height: 40,
                speed: 5,
                color: '#0ff'
            },
            bullets: [],
            enemies: [],
            enemyBullets: [],
            stars: [],
            particles: [],
            score: 0,
            stage: 1,
            lives: 3,
            highScore: 0,
            isRunning: false,
            isPaused: false,
            keys: {},
            lastShot: 0,
            shootDelay: 300,
            enemyShootChance: 0.005,
            
            init() {
                this.highScore = parseInt(localStorage.getItem('galagaHighScore')) || 0;
                document.getElementById('highScore').textContent = this.highScore;
                
                // ë³„ ìƒì„±
                for (let i = 0; i < 50; i++) {
                    this.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 1,
                        speed: Math.random() * 2 + 1
                    });
                }
                
                // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    
                    if (e.key === 'Enter' && !this.isRunning) {
                        this.start();
                    }
                    
                    if (e.key === 'p' || e.key === 'P') {
                        this.pause();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });
            },
            
            start() {
                if (this.isRunning) return;
                
                this.score = 0;
                this.stage = 1;
                this.lives = 3;
                this.bullets = [];
                this.enemies = [];
                this.enemyBullets = [];
                this.particles = [];
                this.player.x = canvas.width / 2 - 20;
                this.player.y = canvas.height - 80;
                this.isPaused = false;
                this.isRunning = true;
                
                document.getElementById('gameOverScreen').classList.remove('show');
                document.getElementById('stageClearScreen').classList.remove('show');
                
                this.createEnemies();
                this.updateStats();
                this.gameLoop();
            },
            
            pause() {
                if (this.isRunning) {
                    this.isPaused = !this.isPaused;
                }
            },
            
            createEnemies() {
                this.enemies = [];
                const rows = 3 + Math.floor(this.stage / 2);
                const cols = 8;
                const enemyWidth = 35;
                const enemyHeight = 35;
                const spacing = 60;
                const startX = (canvas.width - (cols * spacing)) / 2;
                const startY = 50;
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        let type = 'normal';
                        let color = '#f00';
                        let points = 100;
                        let health = 1;
                        
                        if (row === 0 && this.stage >= 3) {
                            type = 'special';
                            color = '#ff0';
                            points = 300;
                            health = 2;
                        } else if (row < 2) {
                            color = '#f0f';
                            points = 200;
                        }
                        
                        this.enemies.push({
                            x: startX + col * spacing,
                            y: startY + row * spacing,
                            width: enemyWidth,
                            height: enemyHeight,
                            speed: 1 + this.stage * 0.3,
                            direction: 1,
                            color: color,
                            type: type,
                            points: points,
                            health: health,
                            maxHealth: health
                        });
                    }
                }
                
                // ë³´ìŠ¤ ì¶”ê°€ (3ìŠ¤í…Œì´ì§€ë§ˆë‹¤)
                if (this.stage % 3 === 0) {
                    this.enemies.push({
                        x: canvas.width / 2 - 25,
                        y: 20,
                        width: 50,
                        height: 40,
                        speed: 2,
                        direction: 1,
                        color: '#f80',
                        type: 'boss',
                        points: 1000,
                        health: 5 + this.stage,
                        maxHealth: 5 + this.stage
                    });
                }
            },
            
            update() {
                if (this.isPaused || !this.isRunning) return;
                
                // í”Œë ˆì´ì–´ ì´ë™
                if (this.keys['ArrowLeft'] && this.player.x > 0) {
                    this.player.x -= this.player.speed;
                }
                if (this.keys['ArrowRight'] && this.player.x < canvas.width - this.player.width) {
                    this.player.x += this.player.speed;
                }
                
                // í”Œë ˆì´ì–´ ë°œì‚¬
                if (this.keys[' ']) {
                    const now = Date.now();
                    if (now - this.lastShot > this.shootDelay) {
                        this.bullets.push({
                            x: this.player.x + this.player.width / 2 - 2,
                            y: this.player.y,
                            width: 4,
                            height: 15,
                            speed: 10,
                            color: '#0ff'
                        });
                        this.lastShot = now;
                    }
                }
                
                // í”Œë ˆì´ì–´ ì´ì•Œ ì´ë™ ë° ì¶©ëŒ
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    this.bullets[i].y -= this.bullets[i].speed;
                    
                    if (this.bullets[i].y < 0) {
                        this.bullets.splice(i, 1);
                        continue;
                    }
                    
                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        if (this.checkCollision(this.bullets[i], this.enemies[j])) {
                            this.enemies[j].health--;
                            
                            if (this.enemies[j].health <= 0) {
                                this.score += this.enemies[j].points;
                                this.createExplosion(this.enemies[j].x + this.enemies[j].width / 2, 
                                                   this.enemies[j].y + this.enemies[j].height / 2);
                                this.enemies.splice(j, 1);
                            }
                            
                            this.bullets.splice(i, 1);
                            this.updateStats();
                            break;
                        }
                    }
                }
                
                // ì  ì´ë™ ë° ë°œì‚¬
                let moveDown = false;
                for (let enemy of this.enemies) {
                    enemy.x += enemy.speed * enemy.direction;
                    
                    if (enemy.x <= 0 || enemy.x >= canvas.width - enemy.width) {
                        moveDown = true;
                    }
                    
                    // ì  ë°œì‚¬
                    if (Math.random() < this.enemyShootChance * (1 + this.stage * 0.2)) {
                        this.enemyBullets.push({
                            x: enemy.x + enemy.width / 2 - 2,
                            y: enemy.y + enemy.height,
                            width: 4,
                            height: 12,
                            speed: 5,
                            color: '#f00'
                        });
                    }
                }
                
                if (moveDown) {
                    for (let enemy of this.enemies) {
                        enemy.direction *= -1;
                        enemy.y += 20;
                    }
                }
                
                // ì  ì´ì•Œ ì´ë™ ë° ì¶©ëŒ
                for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                    this.enemyBullets[i].y += this.enemyBullets[i].speed;
                    
                    if (this.enemyBullets[i].y > canvas.height) {
                        this.enemyBullets.splice(i, 1);
                        continue;
                    }
                    
                    if (this.checkCollision(this.enemyBullets[i], this.player)) {
                        this.playerHit();
                        this.enemyBullets.splice(i, 1);
                    }
                }
                
                // ì ì´ í”Œë ˆì´ì–´ì—ê²Œ ë„ë‹¬í–ˆëŠ”ì§€ í™•ì¸
                for (let enemy of this.enemies) {
                    if (enemy.y + enemy.height >= this.player.y) {
                        this.playerHit();
                        break;
                    }
                }
                
                // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ í™•ì¸
                if (this.enemies.length === 0) {
                    this.stageClear();
                }
                
                // ë³„ ì´ë™
                this.stars.forEach(star => {
                    star.y += star.speed;
                    if (star.y > canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * canvas.width;
                    }
                });
                
                // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    
                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            },
            
            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            },
            
            createExplosion(x, y) {
                for (let i = 0; i < 15; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 6,
                        vy: (Math.random() - 0.5) * 6,
                        life: 30,
                        color: ['#ff0', '#f80', '#f00', '#fff'][Math.floor(Math.random() * 4)]
                    });
                }
            },
            
            playerHit() {
                this.lives--;
                this.updateStats();
                
                this.createExplosion(this.player.x + this.player.width / 2, 
                                   this.player.y + this.player.height / 2);
                
                if (this.lives <= 0) {
                    this.gameOver();
                }
            },
            
            stageClear() {
                // ë ˆë²¨ 10 í´ë¦¬ì–´ ì‹œ ìµœì¢… ìŠ¹ë¦¬!
                if (this.stage >= 10) {
                    this.isRunning = false;
                    
                    // ì ìˆ˜ ì €ì¥
                    saveScore(this.score, this.stage);
                    
                    if (this.score > this.highScore) {
                        this.highScore = this.score;
                        localStorage.setItem('galagaHighScore', this.highScore);
                        document.getElementById('highScore').textContent = this.highScore;
                    }
                    
                    // ìŠ¹ë¦¬ í™”ë©´
                    const clearScreen = document.getElementById('stageClearScreen');
                    clearScreen.querySelector('.stage-clear-title').textContent = 'ğŸ‰ GAME CLEAR! ğŸ‰';
                    clearScreen.querySelector('div:nth-child(2)').innerHTML = 
                        `<div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
                            ìµœì¢… ì ìˆ˜: ${this.score}<br>
                            <span style="color: #0ff;">ëª¨ë“  ë ˆë²¨ì„ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</span>
                        </div>
                        <button class="btn" onclick="game.restart()">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
                        <button class="btn btn-secondary" onclick="showLeaderboardFromGame()">ìˆœìœ„í‘œ ë³´ê¸°</button>`;
                    clearScreen.classList.add('show');
                    return;
                }
                
                this.stage++;
                this.isPaused = true;
                const clearScreen = document.getElementById('stageClearScreen');
                clearScreen.querySelector('.stage-clear-title').textContent = 'STAGE CLEAR!';
                clearScreen.querySelector('div:nth-child(2)').innerHTML = 
                    '<div style="font-size: 24px; color: #fff; margin-bottom: 20px;">ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì¤€ë¹„ì¤‘...</div>';
                clearScreen.classList.add('show');
                
                setTimeout(() => {
                    clearScreen.classList.remove('show');
                    this.createEnemies();
                    this.updateStats();
                    this.isPaused = false;
                }, 2000);
            },
            
            draw() {
                // ë°°ê²½
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ë³„
                this.stars.forEach(star => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(star.x, star.y, star.size, star.size);
                });
                
                // íŒŒí‹°í´
                this.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 30;
                    ctx.fillRect(p.x, p.y, 3, 3);
                    ctx.globalAlpha = 1;
                });
                
                // í”Œë ˆì´ì–´
                ctx.fillStyle = this.player.color;
                ctx.beginPath();
                ctx.moveTo(this.player.x + this.player.width / 2, this.player.y);
                ctx.lineTo(this.player.x, this.player.y + this.player.height);
                ctx.lineTo(this.player.x + this.player.width, this.player.y + this.player.height);
                ctx.closePath();
                ctx.fill();
                
                // í”Œë ˆì´ì–´ ë‚ ê°œ
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(this.player.x - 10, this.player.y + this.player.height - 10, 10, 5);
                ctx.fillRect(this.player.x + this.player.width, this.player.y + this.player.height - 10, 10, 5);
                
                // í”Œë ˆì´ì–´ ì´ì•Œ
                this.bullets.forEach(bullet => {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                    
                    // ì´ì•Œ ë¹› íš¨ê³¼
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                    ctx.shadowBlur = 0;
                });
                
                // ì 
                this.enemies.forEach(enemy => {
                    ctx.fillStyle = enemy.color;
                    
                    if (enemy.type === 'boss') {
                        // ë³´ìŠ¤ ë””ìì¸
                        ctx.fillRect(enemy.x + 5, enemy.y, 25, 10);
                        ctx.fillRect(enemy.x, enemy.y + 10, enemy.width, 15);
                        ctx.fillRect(enemy.x + 10, enemy.y + 25, 15, 10);
                        
                        // ì²´ë ¥ë°”
                        const healthBarWidth = enemy.width;
                        const healthPercent = enemy.health / enemy.maxHealth;
                        ctx.fillStyle = '#333';
                        ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth, 4);
                        ctx.fillStyle = healthPercent > 0.5 ? '#0f0' : healthPercent > 0.25 ? '#ff0' : '#f00';
                        ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth * healthPercent, 4);
                    } else if (enemy.type === 'special') {
                        // íŠ¹ìˆ˜ ì  (ë³„ ëª¨ì–‘)
                        ctx.save();
                        ctx.translate(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                        ctx.rotate(Date.now() / 500);
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            ctx.lineTo(Math.cos((i * 4 * Math.PI) / 5) * 15, 
                                      Math.sin((i * 4 * Math.PI) / 5) * 15);
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore();
                        
                        // ì²´ë ¥ë°”
                        if (enemy.health < enemy.maxHealth) {
                            const healthBarWidth = enemy.width;
                            const healthPercent = enemy.health / enemy.maxHealth;
                            ctx.fillStyle = '#333';
                            ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth, 4);
                            ctx.fillStyle = '#ff0';
                            ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth * healthPercent, 4);
                        }
                    } else {
                        // ì¼ë°˜ ì 
                        ctx.fillRect(enemy.x, enemy.y + 10, enemy.width, 15);
                        ctx.fillRect(enemy.x + 10, enemy.y, 15, 10);
                        ctx.fillRect(enemy.x + 5, enemy.y + 25, 5, 5);
                        ctx.fillRect(enemy.x + 25, enemy.y + 25, 5, 5);
                    }
                });
                
                // ì  ì´ì•Œ
                this.enemyBullets.forEach(bullet => {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                });
                
                // ì¼ì‹œì •ì§€ í‘œì‹œ
                if (this.isPaused && this.isRunning) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
                    ctx.font = 'bold 48px Courier New';
                    ctx.textAlign = 'center';
                    ctx.fillText('PAUSED', canvas.width / 2, canvas.height / 2);
                }
            },
            
            gameLoop() {
                this.update();
                this.draw();
                
                if (this.isRunning) {
                    requestAnimationFrame(() => this.gameLoop());
                }
            },
            
            updateStats() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('stage').textContent = this.stage;
                
                let hearts = '';
                for (let i = 0; i < this.lives; i++) {
                    hearts += 'â¤ï¸';
                }
                document.getElementById('lives').textContent = hearts;
            },
            
            gameOver() {
                this.isRunning = false;
                
                // ì ìˆ˜ ì €ì¥
                saveScore(this.score, this.stage);
                
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('galagaHighScore', this.highScore);
                    document.getElementById('highScore').textContent = this.highScore;
                }
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOverScreen').classList.add('show');
            },
            
            restart() {
                document.getElementById('gameOverScreen').classList.remove('show');
                document.getElementById('stageClearScreen').classList.remove('show');
                this.start();
            }
        };
        
        // ê²Œì„ ì´ˆê¸°í™”
        game.init();
    </script>
</body>
</html>
